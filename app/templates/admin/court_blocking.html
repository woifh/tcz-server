{% extends "base.html" %}

{% block title %}Platz-Sperrungen - Admin - Tennisclub{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Platz-Sperrungen</h2>
    </div>
    
    <div class="mb-6">
        {% if edit_block_data %}
            <h3 class="text-xl font-semibold mb-4">Sperrung bearbeiten</h3>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-blue-800">
                    <strong>Bearbeitung:</strong> 
                    {% if edit_block_data.court_ids|length == 1 %}
                        Platz {{ edit_block_data.court_ids[0] }}
                    {% else %}
                        Plätze {{ edit_block_data.court_ids|join(', ') }}
                    {% endif %}
                    - {{ edit_block_data.date.strftime('%d.%m.%Y') }} 
                    {{ edit_block_data.start_time.strftime('%H:%M') }}-{{ edit_block_data.end_time.strftime('%H:%M') }}
                </p>
            </div>
        {% else %}
            <h3 class="text-xl font-semibold mb-4">Neue Sperrung erstellen</h3>
        {% endif %}
        
        <!-- Block Form -->
        <form id="multi-court-form" action="javascript:void(0)" class="bg-gray-50 p-6 rounded-lg mb-6" 
              data-edit-mode="{{ 'true' if edit_block_data else 'false' }}" 
              data-block-id="{{ edit_block_data.id if edit_block_data else '' }}" 
              data-batch-id="{% if edit_block_data and edit_block_data.batch_id %}{{ edit_block_data.batch_id }}{% endif %}" 
              data-related-block-ids="{{ edit_block_data.related_block_ids|join(',') if edit_block_data else '' }}">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div style="display: flex; flex-direction: row; gap: 1.5rem;">
                    <!-- Left Column: Court Selection -->
                    <div style="width: 33.333333%; flex-shrink: 0;">
                        <label class="block text-gray-700 font-semibold mb-2">Plätze auswählen</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="1" class="mr-2"> Platz 1
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="2" class="mr-2"> Platz 2
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="3" class="mr-2"> Platz 3
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="4" class="mr-2"> Platz 4
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="5" class="mr-2"> Platz 5
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="multi-courts" value="6" class="mr-2"> Platz 6
                            </label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button type="button" id="select-all-courts" class="text-sm text-blue-600 hover:text-blue-800">Alle auswählen</button>
                            <span class="text-sm text-gray-300">•</span>
                            <button type="button" id="clear-all-courts" class="text-sm text-blue-600 hover:text-blue-800">Alle abwählen</button>
                        </div>
                    </div>

                    <!-- Right Column: Date & Time, Reason, Button -->
                    <div style="width: 66.666667%; flex-shrink: 0;">
                        <!-- Date & Time -->
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Datum</label>
                                <input type="date" id="multi-date" name="multi-date" class="border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Von</label>
                                <input type="time" id="multi-start" name="multi-start" class="border border-gray-300 rounded px-3 py-2" style="width: 120px;" value="08:00">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Bis</label>
                                <input type="time" id="multi-end" name="multi-end" class="border border-gray-300 rounded px-3 py-2" style="width: 120px;" value="22:00">
                            </div>
                        </div>
                        
                        <!-- Time Error -->
                        <div id="time-error" class="hidden" style="margin-bottom: 1rem;">
                            <p class="text-sm text-red-600">⚠ Endzeit muss nach Startzeit liegen</p>
                        </div>

                        <!-- Reason Field -->
                        <div style="margin-bottom: 1rem;">
                            <label class="block text-gray-700 font-semibold mb-2">
                                Grund <span class="text-red-500">*</span>
                            </label>
                            <select id="multi-reason" name="multi-reason" class="w-full border border-gray-300 rounded px-3 py-2">
                                <option value="">Grund auswählen...</option>
                            </select>
                        </div>
                        
                        <!-- Details Field -->
                        <div style="margin-bottom: 1rem;">
                            <label class="block text-gray-700 font-semibold mb-2">Details (optional)</label>
                            <input type="text" id="multi-details" name="multi-details" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="z. B. Regen, Reparatur">
                        </div>

                        <!-- Action Buttons -->
                        <div class="form-actions flex gap-3">
                            {% if edit_block_data %}
                                <!-- Edit Mode: 3 buttons -->
                                <button type="submit" id="update-block-btn" disabled class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    Sperrung aktualisieren
                                </button>
                                <button type="button" id="clone-block-btn" disabled class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    Als neues Event speichern
                                </button>
                                <button type="button" id="cancel-btn" class="bg-gray-600 text-white py-2 px-6 rounded hover:bg-gray-700">
                                    Abbrechen
                                </button>
                            {% else %}
                                <!-- Create Mode: 1 button -->
                                <button type="submit" id="create-block-btn" disabled class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                                    Sperrung erstellen
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Upcoming Blocks List -->
    <div class="mb-6">
        <h3 class="text-xl font-semibold mb-4">Kommende Sperrungen</h3>
        <div id="blocks-list" class="bg-white border border-gray-200 rounded-lg">
            <div class="p-4 text-center text-gray-600">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mr-2"></div>
                Lade Sperrungen...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-components.css') }}">
<script type="module" src="{{ url_for('static', filename='js/components/admin/admin-main.js') }}"></script>
<script>
// User context for ownership checks in block management
window.currentUserId = {{ current_user.id }};
window.currentUserIsAdmin = {{ 'true' if current_user.is_admin() else 'false' }};
window.currentUserIsTeamster = {{ 'true' if current_user.is_teamster() else 'false' }};

document.addEventListener('DOMContentLoaded', function() {
    {% if edit_block_data %}
    window.editBlockData = {
        id: {{ edit_block_data.id }},
        batch_id: {% if edit_block_data.batch_id %}'{{ edit_block_data.batch_id }}'{% else %}null{% endif %},
        court_ids: {{ edit_block_data.court_ids|tojson }},
        courts: {{ edit_block_data.court_ids|tojson }},
        date: '{{ edit_block_data.date.isoformat() }}',
        start_time: '{{ edit_block_data.start_time.strftime('%H:%M') }}',
        end_time: '{{ edit_block_data.end_time.strftime('%H:%M') }}',
        reason_id: {{ edit_block_data.reason_id }},
        details: '{{ edit_block_data.details or '' }}',
        description: '{{ edit_block_data.description or '' }}',
        related_block_ids: {{ edit_block_data.related_block_ids|tojson }}
    };
    console.log('Edit block data loaded:', window.editBlockData); // Debug log
    {% endif %}
});
</script>
{% endblock %}