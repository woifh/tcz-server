{% extends "base.html" %}

{% block title %}Übersicht - Tennisclub{% endblock %}

{% block content %}
<style>
    /* Floating time column - shown only when scrolled */
    #floating-time-column {
        display: none;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 20;
        background: white;
        border-right: 1px solid #d1d5db;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
    }
    #floating-time-column table {
        border-collapse: collapse;
    }
    #floating-time-column th,
    #floating-time-column td {
        border: 1px solid #d1d5db;
        border-right: none;
    }
</style>
<!-- Payment Status Banners -->
{% if current_user.has_unpaid_fee() %}
    {% if payment_confirmation_requested %}
    <!-- Payment confirmation pending review -->
    <div class="mb-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
        <div class="flex items-center">
            <span class="material-icons text-blue-600 mr-3">hourglass_empty</span>
            <div>
                <p class="text-blue-800 font-semibold">Zahlungsbestätigung wird geprüft</p>
                {% if is_past_deadline %}
                <p class="text-blue-600 text-xs mt-1">Buchungen sind bis zur Bestätigung weiterhin gesperrt.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif is_past_deadline %}
    <!-- Booking restricted - deadline passed -->
    <div class="mb-4 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="material-icons text-red-600 mr-3">block</span>
                <div>
                    <p class="text-red-800 font-semibold">Buchungen gesperrt</p>
                    <p class="text-red-700 text-sm">Die Zahlungsfrist ist abgelaufen. Bitte zahl deinen Beitrag, um wieder buchen zu können.</p>
                </div>
            </div>
            <button onclick="confirmPayment()"
                    class="ml-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition-colors flex items-center gap-2 whitespace-nowrap">
                <span class="material-icons text-sm">check_circle</span>
                Zahlung bestätigen
            </button>
        </div>
    </div>
    {% elif payment_deadline %}
    <!-- Deadline set but not passed - show countdown -->
    <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="material-icons text-yellow-600 mr-3">schedule</span>
                <div>
                    <p class="text-yellow-800 font-semibold">Mitgliedsbeitrag offen</p>
                    <p class="text-yellow-700 text-sm">
                        {% if days_until_deadline == 0 %}
                        Zahlungsfrist: <strong>Heute</strong> ({{ payment_deadline.strftime('%d.%m.%Y') }})
                        {% elif days_until_deadline == 1 %}
                        Noch <strong>1 Tag</strong> bis zur Zahlungsfrist am {{ payment_deadline.strftime('%d.%m.%Y') }}
                        {% else %}
                        Noch <strong>{{ days_until_deadline }} Tage</strong> bis zur Zahlungsfrist am {{ payment_deadline.strftime('%d.%m.%Y') }}
                        {% endif %}
                    </p>
                </div>
            </div>
            <button onclick="confirmPayment()"
                    class="ml-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition-colors flex items-center gap-2 whitespace-nowrap">
                <span class="material-icons text-sm">check_circle</span>
                Zahlung bestätigen
            </button>
        </div>
    </div>
    {% else %}
    <!-- No deadline set - just reminder -->
    <div class="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <span class="material-icons text-yellow-600 mr-3">warning</span>
                <div>
                    <p class="text-yellow-800 font-semibold">Mitgliedsbeitrag offen</p>
                    <p class="text-yellow-700 text-sm">Dein Mitgliedsbeitrag ist noch nicht bezahlt.</p>
                </div>
            </div>
            <button onclick="confirmPayment()"
                    class="ml-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition-colors flex items-center gap-2 whitespace-nowrap">
                <span class="material-icons text-sm">check_circle</span>
                Zahlung bestätigen
            </button>
        </div>
    </div>
    {% endif %}
{% endif %}

<!-- Email verification reminder -->
{% if current_user.is_authenticated and not current_user.email_verified %}
<div class="mb-4 bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg">
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <span class="material-icons text-orange-600 mr-3">email</span>
            <div>
                <p class="text-orange-800 font-semibold">E-Mail-Adresse nicht bestätigt</p>
                <p class="text-orange-700 text-sm">Du erhältst keine E-Mail-Benachrichtigungen zu deinen Buchungen, bis du deine E-Mail-Adresse bestätigst.</p>
            </div>
        </div>
        <button onclick="resendVerification()"
                id="resend-verification-btn"
                class="ml-4 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded transition-colors flex items-center gap-2 whitespace-nowrap">
            <span class="material-icons text-sm">send</span>
            E-Mail erneut senden
        </button>
    </div>
</div>
{% endif %}

<div class="bg-white rounded-lg shadow-md p-6" x-data="dashboard()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h2 class="hidden lg:flex text-2xl font-bold items-center gap-2">
            <span class="material-icons">calendar_today</span>
            Platzübersicht
        </h2>
        <div class="flex items-center gap-3 ml-auto">
            <button @click="changeDate(-1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded transition-colors flex items-center" title="Vorheriger Tag">
                <span class="material-icons">chevron_left</span>
            </button>
            <input type="date" id="date-selector" x-model="selectedDate" @input="loadAvailability()" class="border border-gray-300 rounded px-3 py-2 w-full lg:w-auto" style="max-width: 300px;">
            <button @click="changeDate(1)" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded transition-colors flex items-center" title="Nächster Tag">
                <span class="material-icons">chevron_right</span>
            </button>
            <button @click="goToToday()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded ml-2 transition-colors flex items-center gap-2" title="Zu heute springen">
                <span class="material-icons">today</span>
                <span class="hidden lg:inline">Heute</span>
            </button>
        </div>
    </div>

    <!-- Legend -->
    <div class="hidden lg:flex gap-6 mb-4 text-sm">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-white border border-gray-300 rounded"></div>
            <span>Verfügbar</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-red-500 rounded"></div>
            <span>Gebucht</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded" style="background-color: #f97316;"></div>
            <span>Kurzfristig gebucht</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-gray-400 rounded"></div>
            <span>Blockiert</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-yellow-400 rounded"></div>
            <span>Vorübergehend gesperrt</span>
        </div>
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-gray-200 rounded"></div>
            <span>Vergangen</span>
        </div>
    </div>

    <!-- Court Availability Grid -->
    <div class="overflow-x-auto relative" id="grid-container">
        <!-- Floating time column (created by JS when scrolling) -->
        <div id="floating-time-column"></div>

        <table class="min-w-full border-collapse" id="availability-grid">
            <thead>
                <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-2 py-2 text-center font-semibold text-sm w-16 bg-gray-100">Uhrzeit</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 1</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 2</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 3</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 4</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 5</th>
                    <th class="border border-gray-300 px-4 py-2 text-center font-semibold">Platz 6</th>
                </tr>
            </thead>
            <tbody id="grid-body">
                <!-- Loading state overlay -->
                <tr x-show="loading && courts.length === 0">
                    <td colspan="7" class="text-center py-8 text-gray-500">Lade Verfügbarkeit...</td>
                </tr>

                <!-- Error state -->
                <tr x-show="error && !loading">
                    <td colspan="7" class="text-center py-8 text-red-500" x-text="error"></td>
                </tr>

                <!-- Grid data - static structure, dynamic content (no DOM recreation) -->
                {% for time_idx in range(14) %}
                <tr x-show="!error" :class="{ 'opacity-50': loading }">
                    <td class="border border-gray-300 px-2 py-2 font-semibold text-center text-sm w-16 bg-white"
                        x-text="timeSlots[{{ time_idx }}] || '{{ '%02d:00'|format(8 + time_idx) }}'"></td>
                    {% for court_idx in range(6) %}
                    <td id="slot-{{ court_idx }}-{{ time_idx }}"
                        :class="courts[{{ court_idx }}]?.slots[{{ time_idx }}]?.cssClass || defaultCellClass"
                        @click="handleSlotClickPrecomputed({{ court_idx }}, {{ time_idx }})"
                        x-html="courts[{{ court_idx }}]?.slots[{{ time_idx }}]?.content ?? 'Frei'">
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile View (Vertical List) -->
    <div id="mobile-grid" class="lg:hidden mt-6 space-y-4">
        <!-- Mobile grid will be populated by JavaScript -->
    </div>

    <!-- User's Active Booking Sessions -->
    <div class="mt-8 border border-gray-200 rounded-lg p-6 bg-blue-50">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold flex items-center gap-2">
                <span class="material-icons">event_note</span>
                Meine aktiven Buchungen
            </h3>
            <a href="{{ url_for('reservations.list_reservations') }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-1">
                Alle anzeigen
                <span class="material-icons text-sm">arrow_forward</span>
            </a>
        </div>
        <div id="user-reservations" class="space-y-3">
            <!-- Loading state -->
            <p x-show="userReservations.length === 0" class="text-gray-500 text-center py-4">
                <span x-show="loading">Lade Buchungen...</span>
                <span x-show="!loading">Keine aktiven Buchungen</span>
            </p>
            
            <!-- Reservations list -->
            <template x-for="reservation in userReservations" :key="reservation.id">
                <div :class="reservation.is_suspended
                    ? 'bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-400'
                    : 'bg-white rounded-lg p-4 border border-gray-200'">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold" x-text="`Platz ${reservation.court_number}`"></h4>
                            <p class="text-sm text-gray-600" x-text="`${formatDate(reservation.date)} • ${reservation.start_time} - ${reservation.end_time}`"></p>
                            <p class="text-sm text-gray-500" x-text="`Gebucht für: ${reservation.booked_for}`"></p>
                            <!-- Suspended badge -->
                            <template x-if="reservation.is_suspended">
                                <div class="mt-2">
                                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        Vorübergehend gesperrt
                                    </span>
                                    <p class="text-xs text-yellow-700 mt-1" x-text="reservation.reason"></p>
                                </div>
                            </template>
                            <span x-show="reservation.is_short_notice"
                                  class="inline-block mt-1 px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded-full">
                                Kurzfristige Buchung
                            </span>
                        </div>
                        <!-- Short-notice bookings can never be cancelled, even when suspended -->
                        <button x-show="!reservation.is_short_notice"
                                @click="cancelReservation(reservation.id)"
                                class="text-red-600 hover:text-red-900 p-1"
                                title="Stornieren">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        <span x-show="reservation.is_short_notice"
                              class="text-gray-500 text-sm">
                            Nicht stornierbar
                        </span>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Availability Summary -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="bg-white rounded p-3">
                    <div class="text-gray-600">Verfügbare Buchungsplätze</div>
                    <div class="text-lg font-semibold text-green-600" x-text="getAvailableSlots() + ' von 2'"></div>
                </div>
                <div class="bg-white rounded p-3">
                    <div class="text-gray-600">Kurzfristige Buchungen</div>
                    <div class="text-lg font-semibold text-orange-600" x-text="getShortNoticeSlots() + ' von 1'"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Made for Others -->
    <div x-show="bookingsForOthers.length > 0" class="mt-8 border border-gray-200 rounded-lg p-6 bg-purple-50">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold flex items-center gap-2">
                <span class="material-icons">people</span>
                Buchungen für andere
            </h3>
        </div>
        <div class="space-y-3">
            <template x-for="reservation in bookingsForOthers" :key="reservation.id">
                <div :class="reservation.is_suspended ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-white'" class="rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold" x-text="`Platz ${reservation.court_number}`"></h4>
                            <p class="text-sm text-gray-600" x-text="`${formatDate(reservation.date)} • ${reservation.start_time} - ${reservation.end_time}`"></p>
                            <p class="text-sm text-gray-500" x-text="`Gebucht für: ${reservation.booked_for}`"></p>
                            <!-- Suspended badge -->
                            <template x-if="reservation.is_suspended">
                                <div class="mt-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                        ⚠ Vorübergehend gesperrt
                                    </span>
                                    <p class="text-xs text-yellow-700 mt-1" x-text="reservation.reason"></p>
                                </div>
                            </template>
                            <span x-show="reservation.is_short_notice"
                                  class="inline-block mt-1 px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded-full">
                                Kurzfristige Buchung
                            </span>
                        </div>
                        <!-- Short-notice bookings can never be cancelled, even when suspended -->
                        <button x-show="!reservation.is_short_notice"
                                @click="cancelReservation(reservation.id)"
                                class="text-red-600 hover:text-red-900 p-1"
                                title="Stornieren">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        <span x-show="reservation.is_short_notice"
                              class="text-gray-500 text-sm">
                            Nicht stornierbar
                        </span>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Booking Modal (Alpine.js) -->
<div x-data="bookingModal()" x-init="init()" 
     x-show="show" 
     x-cloak
     @keydown.escape.window="close()"
     @click.self="close()"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Buchung erstellen</h3>
        <form @submit.prevent="submit()">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Datum</label>
                <input type="date" x-model="date" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Platz</label>
                <input type="text" x-model="courtName" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Uhrzeit</label>
                <input type="text" x-model="getTimeRange()" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100" readonly>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Gebucht für</label>
                <select x-model="bookedFor" class="w-full border border-gray-300 rounded px-3 py-2" id="booking-for">
                    <option value="{{ current_user.id }}">{{ current_user.name }} (Ich)</option>
                    <template x-for="fav in (favourites || [])" :key="fav.id">
                        <option :value="fav.id" x-text="fav.name"></option>
                    </template>
                </select>

                <!-- Toggle member search -->
                <button type="button"
                        @click="toggleSearch()"
                        class="mt-2 text-sm text-green-600 hover:text-green-800 flex items-center gap-1">
                    <span class="material-icons text-sm">search</span>
                    <span x-text="showSearch ? 'Suche schließen' : 'Anderes Mitglied suchen'"></span>
                </button>

                <!-- Member search panel -->
                <div x-show="showSearch" x-cloak class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <!-- Search input -->
                    <div class="relative">
                        <input type="text"
                               id="booking-member-search"
                               x-model="searchQuery"
                               @input.debounce.300ms="searchMembers()"
                               @keydown.arrow-down.prevent="searchHighlightNext()"
                               @keydown.arrow-up.prevent="searchHighlightPrevious()"
                               @keydown.enter.prevent="searchSelectHighlighted()"
                               class="w-full border border-gray-300 rounded px-3 py-2 pr-10 text-sm"
                               placeholder="Name oder E-Mail eingeben..."
                               autocomplete="off">
                        <!-- Loading spinner -->
                        <div x-show="searchLoading" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <svg class="animate-spin h-4 w-4 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Search error -->
                    <div x-show="searchError" x-text="searchError" class="mt-2 text-sm text-red-600"></div>

                    <!-- Search results -->
                    <div x-show="searchResults.length > 0" class="mt-2 max-h-40 overflow-y-auto">
                        <template x-for="(member, index) in searchResults" :key="member.id">
                            <button type="button"
                                    @click="selectSearchResult(member)"
                                    :class="{ 'bg-green-100': index === searchHighlightIndex }"
                                    class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded flex justify-between items-center">
                                <span x-text="member.name"></span>
                                <span class="text-xs text-gray-500" x-text="member.email"></span>
                            </button>
                        </template>
                    </div>

                    <!-- No results message -->
                    <div x-show="searchQuery.trim() && !searchLoading && searchResults.length === 0 && !searchError"
                         class="mt-2 text-sm text-gray-500 text-center py-2">
                        Keine Mitglieder gefunden
                    </div>

                    <!-- Help text -->
                    <p class="mt-2 text-xs text-gray-500">
                        Ausgewählte Mitglieder werden automatisch zu deinen Favoriten hinzugefügt.
                    </p>
                </div>
            </div>

            <div x-show="error" x-text="error" class="mb-4 p-3 bg-red-100 text-red-800 rounded whitespace-pre-line"></div>
            
            <div class="flex gap-4">
                <button type="submit" 
                        :disabled="submitting"
                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 flex items-center justify-center gap-2 disabled:opacity-50">
                    <span class="material-icons">check</span>
                    <span x-text="submitting ? 'Wird erstellt...' : 'Buchung bestätigen'"></span>
                </button>
                <button type="button" @click="close()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 flex items-center justify-center gap-2">
                    <span class="material-icons">close</span>
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Payment confirmation function
async function confirmPayment() {
    if (!confirm('Hast du deinen Mitgliedsbeitrag bereits bezahlt? Mit dieser Bestätigung informierst du den Vorstand, dass deine Zahlung erfolgt ist.')) {
        return;
    }

    try {
        const response = await fetch('/api/members/me/confirm-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Zahlungsbestätigung wurde angefordert');
            // Reload page to show updated banner
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast(data.error || 'Fehler bei der Zahlungsbestätigung', 'error');
        }
    } catch (error) {
        showToast('Fehler bei der Zahlungsbestätigung', 'error');
    }
}

async function resendVerification() {
    const btn = document.getElementById('resend-verification-btn');

    // Disable button during request
    btn.disabled = true;
    btn.innerHTML = '<span class="material-icons text-sm animate-spin">refresh</span> Wird gesendet...';

    try {
        const response = await fetch('/auth/resend-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Bestätigungs-E-Mail wurde gesendet! Bitte prüfe dein Postfach.');
            btn.innerHTML = '<span class="material-icons text-sm">check</span> E-Mail gesendet';
            btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            btn.classList.add('bg-green-600');
        } else {
            showToast(data.error || 'Fehler beim Senden', 'error');
            btn.disabled = false;
            btn.innerHTML = '<span class="material-icons text-sm">send</span> E-Mail erneut senden';
        }
    } catch (error) {
        showToast('Fehler beim Senden der E-Mail', 'error');
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons text-sm">send</span> E-Mail erneut senden';
    }
}

// Booking modal event handlers - now handled by Alpine.js components
document.addEventListener('DOMContentLoaded', () => {
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('booking-modal') && !document.getElementById('booking-modal').classList.contains('hidden')) {
            closeBookingModal();
        }
    });

    // Close modal on background click
    const modal = document.getElementById('booking-modal');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'booking-modal') {
                closeBookingModal();
            }
        });
    }

    // Floating time column on horizontal scroll
    const gridContainer = document.getElementById('grid-container');
    const floatingCol = document.getElementById('floating-time-column');
    const table = document.getElementById('availability-grid');

    if (gridContainer && floatingCol && table) {
        function updateFloatingColumn() {
            const scrollLeft = gridContainer.scrollLeft;

            if (scrollLeft > 0) {
                // Build floating column from current table data
                const rows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
                const headerRow = table.querySelector('thead tr');
                let html = '<table>';

                // Add header
                if (headerRow) {
                    const headerCell = headerRow.querySelector('th');
                    if (headerCell) {
                        const height = headerCell.offsetHeight;
                        html += `<tr><th class="px-2 py-2 font-semibold text-center text-sm bg-gray-100" style="height:${height}px">${headerCell.textContent}</th></tr>`;
                    }
                }

                // Add body rows
                rows.forEach((row) => {
                    const firstCell = row.querySelector('td');
                    if (firstCell && row.offsetHeight > 0) {
                        const height = firstCell.offsetHeight;
                        html += `<tr><td class="px-2 py-2 font-semibold text-center text-sm bg-white" style="height:${height}px">${firstCell.textContent}</td></tr>`;
                    }
                });

                html += '</table>';
                floatingCol.innerHTML = html;
                floatingCol.style.display = 'block';
            } else {
                floatingCol.style.display = 'none';
            }
        }

        gridContainer.addEventListener('scroll', updateFloatingColumn);
    }
});
</script>

<script type="module">
import { dashboard } from '{{ url_for("static", filename="js/components/dashboard.js") }}';
import { bookingModal } from '{{ url_for("static", filename="js/components/booking-modal.js") }}';

// Set global authentication status for authenticated users
window.isAuthenticated = true;

// Make components globally available for Alpine
window.dashboard = dashboard;
window.bookingModal = bookingModal;

// Re-initialize Alpine components if Alpine already loaded
// This handles the race condition where Alpine loads before our module
if (window.Alpine) {
    // Find elements that need reinitialization
    document.querySelectorAll('[x-data*="bookingModal"]').forEach(el => {
        // Destroy existing (broken) Alpine state and reinitialize
        window.Alpine.destroyTree(el);
        window.Alpine.initTree(el);
    });
    document.querySelectorAll('[x-data*="dashboard"]').forEach(el => {
        window.Alpine.destroyTree(el);
        window.Alpine.initTree(el);
    });
}

console.log('Alpine components loaded');
</script>
{% endblock %}
