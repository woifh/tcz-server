{% extends "base.html" %}

{% block title %}Mitglieder - Tennisclub{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Mitglieder</h2>
        {% if current_user.is_admin() %}
        <button onclick="showNewMemberForm()" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
            Neues Mitglied
        </button>
        {% endif %}
    </div>
    
    <!-- New Member Form (Hidden by default) -->
    {% if current_user.is_admin() %}
    <div id="new-member-form" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Neues Mitglied erstellen</h3>
        <form id="create-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Vorname</label>
                <input type="text" id="new-member-firstname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Nachname</label>
                <input type="text" id="new-member-lastname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                <input type="email" id="new-member-email" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Passwort</label>
                <input type="password" id="new-member-password" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Rolle</label>
                <select id="new-member-role" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="member">Mitglied</option>
                    <option value="teamster">Mannschaftsführer</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div class="md:col-span-2 flex gap-4">
                <button type="submit" class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700">
                    Erstellen
                </button>
                <button type="button" onclick="hideNewMemberForm()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded hover:bg-gray-400">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>

    <!-- Edit Member Form (Hidden by default) -->
    <div id="edit-member-form" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Mitglied bearbeiten</h3>
        <form id="update-member-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="edit-member-id">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Vorname</label>
                <input type="text" id="edit-member-firstname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Nachname</label>
                <input type="text" id="edit-member-lastname" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                <input type="email" id="edit-member-email" class="w-full border border-gray-300 rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Neues Passwort (optional)</label>
                <input type="password" id="edit-member-password" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Leer lassen, um beizubehalten">
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Rolle</label>
                <select id="edit-member-role" class="w-full border border-gray-300 rounded px-3 py-2">
                    <option value="member">Mitglied</option>
                    <option value="teamster">Mannschaftsführer</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Status</label>
                <div class="flex items-center gap-4 mt-2">
                    <label class="flex items-center">
                        <input type="radio" name="member-status" value="active" id="edit-member-active" class="mr-2">
                        <span class="text-sm">Aktiv</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="member-status" value="inactive" id="edit-member-inactive" class="mr-2">
                        <span class="text-sm">Deaktiviert</span>
                    </label>
                </div>
            </div>
            <div class="md:col-span-2 flex gap-4">
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">
                    Aktualisieren
                </button>
                <button type="button" onclick="hideEditMemberForm()" class="bg-gray-300 text-gray-700 py-2 px-6 rounded hover:bg-gray-400">
                    Abbrechen
                </button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-Mail</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rolle</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktive Buchungen</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Erstellt am</th>
                    {% if current_user.is_admin() %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for member in members %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="{% if member.role == 'administrator' %}text-yellow-600{% elif member.role == 'teamster' %}text-blue-600{% else %}text-gray-600{% endif %} font-semibold">
                            {{ 'Administrator' if member.role == 'administrator' else 'Mannschaftsführer' if member.role == 'teamster' else 'Mitglied' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">
                            <div class="text-gray-900 font-medium">{{ member.active_booking_count }} / 2 Aktive</div>
                            <div class="text-gray-500">{{ member.short_notice_count }} / 1 Kurzfristig</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                        {{ member.created_at.strftime('%d.%m.%Y') }}
                    </td>
                    {% if current_user.is_admin() %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="editMember({{ member.id }})" class="text-blue-600 hover:text-blue-900 mr-3">Bearbeiten</button>
                        {% if member.id != current_user.id %}
                        <button onclick="deleteMember({{ member.id }})" class="text-red-600 hover:text-red-900">Löschen</button>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
</div>

<script>
function showNewMemberForm() {
    hideEditMemberForm(); // Hide edit form if open
    document.getElementById('new-member-form').classList.remove('hidden');
}

function hideNewMemberForm() {
    document.getElementById('new-member-form').classList.add('hidden');
    document.getElementById('create-member-form').reset();
}

function showEditMemberForm() {
    hideNewMemberForm(); // Hide create form if open
    document.getElementById('edit-member-form').classList.remove('hidden');
    // Scroll to the form
    document.getElementById('edit-member-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideEditMemberForm() {
    document.getElementById('edit-member-form').classList.add('hidden');
    document.getElementById('update-member-form').reset();
}

document.getElementById('create-member-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const memberData = {
        firstname: document.getElementById('new-member-firstname').value,
        lastname: document.getElementById('new-member-lastname').value,
        email: document.getElementById('new-member-email').value,
        password: document.getElementById('new-member-password').value,
        role: document.getElementById('new-member-role').value
    };

    try {
        const response = await fetch('/members/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Mitglied erfolgreich erstellt!');
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast(data.error || 'Unbekannter Fehler', 'error');
        }
    } catch (error) {
        showToast('Fehler beim Erstellen des Mitglieds', 'error');
    }
});

document.getElementById('update-member-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const memberId = document.getElementById('edit-member-id').value;
    const currentStatus = document.querySelector('input[name="member-status"]:checked').value;
    const wasActive = document.getElementById('edit-member-form').dataset.wasActive === 'true';

    const memberData = {
        firstname: document.getElementById('edit-member-firstname').value,
        lastname: document.getElementById('edit-member-lastname').value,
        email: document.getElementById('edit-member-email').value,
        role: document.getElementById('edit-member-role').value
    };

    // Only include password if provided
    const password = document.getElementById('edit-member-password').value;
    if (password) {
        memberData.password = password;
    }

    try {
        // First update the member data
        const response = await fetch(`/members/${memberId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        });

        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || 'Fehler beim Aktualisieren', 'error');
            return;
        }

        // Handle status change (activate/deactivate) if needed
        if (currentStatus === 'inactive' && wasActive) {
            // Deactivate the member
            const deactivateResponse = await fetch(`/members/${memberId}/deactivate`, {
                method: 'POST'
            });

            if (!deactivateResponse.ok) {
                const deactivateData = await deactivateResponse.json();
                showToast(deactivateData.error || 'Fehler beim Deaktivieren', 'error');
                return;
            }
        } else if (currentStatus === 'active' && !wasActive) {
            // Reactivate the member
            const reactivateResponse = await fetch(`/members/${memberId}/reactivate`, {
                method: 'POST'
            });

            if (!reactivateResponse.ok) {
                const reactivateData = await reactivateResponse.json();
                showToast(reactivateData.error || 'Fehler beim Reaktivieren', 'error');
                return;
            }
        }

        showToast('Mitglied erfolgreich aktualisiert!');
        setTimeout(() => window.location.reload(), 500);

    } catch (error) {
        showToast('Fehler beim Aktualisieren des Mitglieds', 'error');
    }
});

async function editMember(memberId) {
    try {
        // Fetch member details
        const response = await fetch(`/members/${memberId}`);
        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || 'Fehler beim Laden der Mitgliedsdaten', 'error');
            return;
        }

        // Populate the form
        document.getElementById('edit-member-id').value = data.id;
        document.getElementById('edit-member-firstname').value = data.firstname;
        document.getElementById('edit-member-lastname').value = data.lastname;
        document.getElementById('edit-member-email').value = data.email;
        document.getElementById('edit-member-role').value = data.role;
        document.getElementById('edit-member-password').value = '';

        // Set status radio buttons
        if (data.is_active) {
            document.getElementById('edit-member-active').checked = true;
        } else {
            document.getElementById('edit-member-inactive').checked = true;
        }

        // Store original active status for comparison
        document.getElementById('edit-member-form').dataset.wasActive = data.is_active;

        // Show the edit form
        showEditMemberForm();

    } catch (error) {
        showToast('Fehler beim Laden der Mitgliedsdaten', 'error');
    }
}

async function deleteMember(memberId) {
    if (!confirm('Möchten Sie dieses Mitglied wirklich löschen?')) {
        return;
    }

    try {
        const response = await fetch(`/members/${memberId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Mitglied erfolgreich gelöscht!');
            setTimeout(() => window.location.reload(), 500);
        } else {
            // If deletion failed due to active reservations, ask if they want to force delete
            if (data.error && data.error.includes('aktive Buchungen')) {
                if (confirm(data.error + '\n\nMöchten Sie das Mitglied trotzdem löschen? Alle Buchungen werden storniert.')) {
                    // Force delete
                    const forceResponse = await fetch(`/members/${memberId}?force=true`, {
                        method: 'DELETE'
                    });
                    const forceData = await forceResponse.json();

                    if (forceResponse.ok) {
                        showToast('Mitglied und alle Buchungen erfolgreich gelöscht!');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        showToast(forceData.error || 'Unbekannter Fehler', 'error');
                    }
                }
            } else {
                showToast(data.error || 'Unbekannter Fehler', 'error');
            }
        }
    } catch (error) {
        showToast('Fehler beim Löschen des Mitglieds', 'error');
    }
}
</script>
{% endblock %}
