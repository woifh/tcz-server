{% extends "base.html" %}

{% block title %}Mitglieder - Tennisclub{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Mitglieder</h2>
        {% if current_user.is_admin() %}
        <a href="/admin/member" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
            Neues Mitglied
        </a>
        {% endif %}
    </div>

    <div class="mb-4">
        <div class="relative flex-1 sm:flex-initial">
            <input
                type="text"
                id="member-filter"
                placeholder="Mitglieder durchsuchen..."
                class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent focus:outline-none"
                aria-label="Mitglieder durchsuchen"
            >
            <span class="material-icons absolute left-3 top-2.5 text-gray-400 text-sm pointer-events-none">search</span>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table id="members-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="name">
                        <span class="flex items-center gap-1">Name <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="email">
                        <span class="flex items-center gap-1">E-Mail <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="role">
                        <span class="flex items-center gap-1">Rolle <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="membership">
                        <span class="flex items-center gap-1">Mitgliedschaft <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="payment">
                        <span class="flex items-center gap-1">Beitrag <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="bookings">
                        <span class="flex items-center gap-1">Buchungen <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" data-sort="created">
                        <span class="flex items-center gap-1">Erstellt am <svg class="sort-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg></span>
                    </th>
                    {% if current_user.is_admin() %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for member in members %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ member.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="{% if member.role == 'administrator' %}text-yellow-600{% elif member.role == 'teamster' %}text-blue-600{% else %}text-gray-600{% endif %}">
                            {{ 'Administrator' if member.role == 'administrator' else 'Mannschaftsführer' if member.role == 'teamster' else 'Mitglied' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="{% if member.membership_type == 'full' %}text-green-600{% else %}text-blue-600{% endif %}">
                            {{ 'Vollmitglied' if member.membership_type == 'full' else 'Fördermitglied' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if member.fee_paid %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <span class="material-icons text-xs mr-1">check_circle</span>
                            Bezahlt
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <span class="material-icons text-xs mr-1">warning</span>
                            Offen
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">
                            <div class="text-gray-500">{{ member.total_booking_count|default(0) }} Buchungen</div>
                            <div class="text-gray-500">{{ member.short_notice_count|default(0) }} Kurzfristig</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                        {{ member.created_at.strftime('%d.%m.%Y') }}
                    </td>
                    {% if current_user.is_admin() %}
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="/admin/member/{{ member.id }}" class="text-blue-600 hover:text-blue-900 p-1" title="Bearbeiten">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </a>
                        {% if member.id != current_user.id %}
                        <button onclick="deleteMember({{ member.id }})" class="text-red-600 hover:text-red-900 p-1 ml-2" title="Löschen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
async function deleteMember(memberId) {
    if (!confirm('Möchten Sie dieses Mitglied wirklich löschen?')) {
        return;
    }

    try {
        const response = await fetch(`/members/${memberId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showToast('Mitglied erfolgreich gelöscht!');
            setTimeout(() => window.location.reload(), 500);
        } else {
            // If deletion failed due to active reservations, ask if they want to force delete
            if (data.error && data.error.includes('aktive Buchungen')) {
                if (confirm(data.error + '\n\nMöchten Sie das Mitglied trotzdem löschen? Alle Buchungen werden storniert.')) {
                    // Force delete
                    const forceResponse = await fetch(`/members/${memberId}?force=true`, {
                        method: 'DELETE'
                    });
                    const forceData = await forceResponse.json();

                    if (forceResponse.ok) {
                        showToast('Mitglied und alle Buchungen erfolgreich gelöscht!');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        showToast(forceData.error || 'Unbekannter Fehler', 'error');
                    }
                }
            } else {
                showToast(data.error || 'Unbekannter Fehler', 'error');
            }
        }
    } catch (error) {
        showToast('Fehler beim Löschen des Mitglieds', 'error');
    }
}

// Quick filter functionality
(function() {
    const filterInput = document.getElementById('member-filter');
    const table = document.getElementById('members-table');
    if (!filterInput || !table) return;

    filterInput.addEventListener('input', () => {
        const filter = filterInput.value.toLowerCase().trim();
        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const name = row.cells[0]?.textContent.toLowerCase() || '';
            const email = row.cells[1]?.textContent.toLowerCase() || '';
            const matches = name.includes(filter) || email.includes(filter);
            row.style.display = matches ? '' : 'none';
        });
    });
})();

// Table sorting functionality
(function() {
    const table = document.getElementById('members-table');
    if (!table) return;

    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, direction: 'asc' };

    // SVG paths for different states
    const defaultIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>';
    const ascIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
    const descIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';

            sortTable(column, direction);
            currentSort = { column, direction };

            // Update sort icons
            headers.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (h === header) {
                    icon.innerHTML = direction === 'asc' ? ascIcon : descIcon;
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-gray-700');
                } else {
                    icon.innerHTML = defaultIcon;
                    icon.classList.remove('text-gray-700');
                    icon.classList.add('text-gray-400');
                }
            });
        });
    });

    function sortTable(column, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        const columnIndex = {
            'name': 0,
            'email': 1,
            'role': 2,
            'membership': 3,
            'payment': 4,
            'bookings': 5,
            'created': 6
        }[column];

        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex]?.textContent.trim() || '';
            let bVal = b.cells[columnIndex]?.textContent.trim() || '';

            // Handle date sorting (DD.MM.YYYY format)
            if (column === 'created') {
                const parseDate = (str) => {
                    const parts = str.split('.');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                };
                aVal = parseDate(aVal);
                bVal = parseDate(bVal);
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle numeric sorting for bookings (extract number from "X Buchungen")
            if (column === 'bookings') {
                aVal = parseInt(aVal.match(/\d+/)?.[0]) || 0;
                bVal = parseInt(bVal.match(/\d+/)?.[0]) || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle role sorting (by priority: administrator > teamster > member)
            if (column === 'role') {
                const rolePriority = { 'Administrator': 3, 'Mannschaftsführer': 2, 'Mitglied': 1 };
                aVal = rolePriority[aVal] || 0;
                bVal = rolePriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle membership sorting (Vollmitglied > Fördermitglied)
            if (column === 'membership') {
                const membershipPriority = { 'Vollmitglied': 2, 'Fördermitglied': 1 };
                aVal = membershipPriority[aVal] || 0;
                bVal = membershipPriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Handle payment sorting (Bezahlt > Offen)
            if (column === 'payment') {
                const paymentPriority = { 'Bezahlt': 2, 'Offen': 1 };
                aVal = paymentPriority[aVal] || 0;
                bVal = paymentPriority[bVal] || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }

            // Default string sorting
            return direction === 'asc'
                ? aVal.localeCompare(bVal, 'de')
                : bVal.localeCompare(aVal, 'de');
        });

        rows.forEach(row => tbody.appendChild(row));
    }
})();
</script>
{% endblock %}
